name: Build ungoogled-chromium macOS ARM64

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Chromium version (leave empty for latest)'
        required: false
        default: ''

env:
  # Force Python 3.11 (3.14 breaks depot_tools)
  PATH: /opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:/usr/bin:/bin:/usr/sbin:/sbin

jobs:
  build:
    name: Build for macOS ARM64
    runs-on: self-hosted
    timeout-minutes: 1440

    steps:
      - name: Checkout ungoogled-chromium
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: System info
        run: |
          echo "=== System Info ==="
          uname -a
          sysctl -n machdep.cpu.brand_string
          df -h
          echo "RAM: $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 )) GB"

      - name: Install dependencies
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          brew update || true
          brew install ninja ccache python@3.11 wget coreutils || true
          
          # Force Python 3.11
          brew link --overwrite python@3.11 || true

      - name: Setup Python 3.11
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          echo "Python version:"
          python3 --version
          which python3
          
          # Install required packages
          python3 -m pip install --user httplib2 six

      - name: Clone macOS build scripts
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          cd ${{ github.workspace }}/..
          rm -rf ungoogled-chromium-macos || true
          git clone --depth 1 https://github.com/ungoogled-software/ungoogled-chromium-macos.git
          cd ungoogled-chromium-macos
          
          # Link our ungoogled-chromium checkout
          rm -rf ungoogled-chromium || true
          ln -s ${{ github.workspace }} ungoogled-chromium

      - name: Download Chromium source
        working-directory: ../ungoogled-chromium-macos
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          python3 --version
          ./build.sh download

      - name: Prepare source
        working-directory: ../ungoogled-chromium-macos
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          ./build.sh unpack
          ./build.sh prepare

      - name: Configure lite build (automation)
        working-directory: ../ungoogled-chromium-macos
        run: |
          cat >> build/src/out/Default/args.gn << 'EOF'
          
          # Lite build for automation
          enable_nacl = false
          enable_widevine = false
          enable_hangout_services_extension = false
          enable_remoting = false
          enable_reporting = false
          is_official_build = true
          is_debug = false
          symbol_level = 0
          cc_wrapper = "ccache"
          target_cpu = "arm64"
          EOF

      - name: Build
        working-directory: ../ungoogled-chromium-macos
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/opt/ccache/libexec:/opt/homebrew/bin:$PATH"
          export CCACHE_MAXSIZE="30G"
          ./build.sh build

      - name: Package
        working-directory: ../ungoogled-chromium-macos
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          ./build.sh package
          mkdir -p ${{ github.workspace }}/dist
          cp build/chromium-*.dmg ${{ github.workspace }}/dist/ 2>/dev/null || true
          cp build/*.tar.xz ${{ github.workspace }}/dist/ 2>/dev/null || true
          
          if [ -d "build/src/out/Default/Chromium.app" ]; then
            cd build/src/out/Default
            ditto -c -k --sequesterRsrc Chromium.app ${{ github.workspace }}/dist/ungoogled-chromium-arm64.zip
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ungoogled-chromium-macos-arm64
          path: dist/*
          retention-days: 90
