name: Build ungoogled-chromium macOS ARM64

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Chromium version (leave empty for latest)'
        required: false
        default: ''

jobs:
  build:
    name: Build for macOS ARM64
    runs-on: self-hosted
    timeout-minutes: 1440

    env:
      # Force Python 3.11
      PYTHON: /opt/homebrew/opt/python@3.11/libexec/bin/python3

    steps:
      - name: Checkout ungoogled-chromium
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: System info
        run: |
          echo "=== System Info ==="
          uname -a
          sysctl -n machdep.cpu.brand_string
          df -h
          echo "RAM: $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 )) GB"

      - name: Install dependencies
        run: |
          export PATH="/opt/homebrew/bin:$PATH"
          brew update || true
          brew install ninja ccache python@3.11 wget coreutils rustup || true
          
          # Setup Rust for ARM64 only
          rustup-init -y --default-toolchain stable --target aarch64-apple-darwin
          source ~/.cargo/env
          rustup target add aarch64-apple-darwin

      - name: Setup Python 3.11
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          echo "Python version:"
          python3 --version
          python3 -m pip install --user httplib2 six

      - name: Clone macOS build scripts
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          cd ${{ github.workspace }}/..
          rm -rf ungoogled-chromium-macos || true
          git clone --depth 1 https://github.com/ungoogled-software/ungoogled-chromium-macos.git
          cd ungoogled-chromium-macos
          
          # Link our ungoogled-chromium checkout
          rm -rf ungoogled-chromium || true
          ln -s ${{ github.workspace }} ungoogled-chromium

      - name: Download Chromium source
        working-directory: ../ungoogled-chromium-macos
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          ./build.sh download

      - name: Prepare source
        working-directory: ../ungoogled-chromium-macos
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$PATH"
          ./build.sh unpack
          ./build.sh prepare

      - name: Configure ARM64-only build
        working-directory: ../ungoogled-chromium-macos
        run: |
          # Override args.gn to force ARM64 only (no universal/x86_64)
          cat > build/src/out/Default/args.gn << 'EOF'
          # === ARM64-only build (no universal binary) ===
          target_cpu = "arm64"
          target_os = "mac"
          
          # Disable x86_64 cross-compile
          use_lld = true
          
          # Lite build for automation
          enable_nacl = false
          enable_widevine = false
          enable_hangout_services_extension = false
          enable_remoting = false
          enable_reporting = false
          
          # Official build optimizations
          is_official_build = true
          is_debug = false
          symbol_level = 0
          blink_symbol_level = 0
          
          # ccache
          cc_wrapper = "ccache"
          
          # ungoogled-chromium flags
          is_cfi = false
          use_cfi_cast = false
          use_thin_lto = true
          chrome_pgo_phase = 0
          EOF
          
          echo "=== args.gn ==="
          cat build/src/out/Default/args.gn

      - name: Regenerate build files
        working-directory: ../ungoogled-chromium-macos/build/src
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/bin:$HOME/.cargo/bin:$PATH"
          source ~/.cargo/env || true
          ./out/Default/gn gen out/Default --fail-on-unused-args

      - name: Build
        working-directory: ../ungoogled-chromium-macos/build/src
        run: |
          export PATH="/opt/homebrew/opt/python@3.11/libexec/bin:/opt/homebrew/opt/ccache/libexec:/opt/homebrew/bin:$HOME/.cargo/bin:$PATH"
          export CCACHE_MAXSIZE="30G"
          source ~/.cargo/env || true
          
          # Build Chromium
          ninja -C out/Default chrome

      - name: Package
        working-directory: ../ungoogled-chromium-macos/build/src
        run: |
          mkdir -p ${{ github.workspace }}/dist
          
          if [ -d "out/Default/Chromium.app" ]; then
            cd out/Default
            ditto -c -k --sequesterRsrc Chromium.app ${{ github.workspace }}/dist/ungoogled-chromium-arm64.zip
            echo "✅ Package created!"
          else
            echo "❌ Chromium.app not found"
            ls -la out/Default/
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ungoogled-chromium-macos-arm64
          path: dist/*
          retention-days: 90
